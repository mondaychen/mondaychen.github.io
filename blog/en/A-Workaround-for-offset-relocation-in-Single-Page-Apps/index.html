<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Monday Chen&amp;#39;s personal website and blog"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><title>Monday's here</title><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon/favicon.ico"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon/favicon-194x194.png" sizes="194x194"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon/android-chrome-192x192.png" sizes="192x192"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons"><link data-n-head="ssr" rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-c77408be8058.css"><link rel="preload" href="/_nuxt/f477db7.js" as="script"><link rel="preload" href="/_nuxt/e378fc1.js" as="script"><link rel="preload" href="/_nuxt/css/53eea7e.css" as="style"><link rel="preload" href="/_nuxt/a8e9045.js" as="script"><link rel="preload" href="/_nuxt/css/a29bc8e.css" as="style"><link rel="preload" href="/_nuxt/e1b5a9c.js" as="script"><link rel="stylesheet" href="/_nuxt/css/53eea7e.css"><link rel="stylesheet" href="/_nuxt/css/a29bc8e.css"><link rel="preload" href="/_nuxt/static/1716479539/blog/en/A-Workaround-for-offset-relocation-in-Single-Page-Apps/state.js" as="script"><link rel="preload" href="/_nuxt/static/1716479539/blog/en/A-Workaround-for-offset-relocation-in-Single-Page-Apps/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1716479539/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="page-container md-layout-column" data-v-61d4e336><div id="app" class="md-app md-app-side-drawer md-layout-row md-theme-default" data-v-61d4e336><div md-permanent="full" md-swipeable="" class="md-drawer md-app-drawer drawer md-theme-default md-left md-permanent md-permanent-full" data-v-61d4e336><div class="md-toolbar logo-wrapper md-transparent md-theme-default md-elevation-0" data-v-61d4e336><a href="/" class="md-button logo router-link-active md-active md-theme-default" data-v-352eaaaf data-v-61d4e336><div class="md-ripple"><div class="md-button-content"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="121.12px" height="111.782px" viewBox="0 0 121.12 111.782" enable-background="new 0 0 121.12 111.782" xml:space="preserve" data-v-352eaaaf><path d="M30.146,51.223v60.56H0V0.267l60.293,42.152L121.12,0v29.346L60.293,74.433L30.146,51.223z" class="p1" data-v-352eaaaf></path> <polygon points="121.12,37.884 121.12,111.783 90.972,111.783 90.972,60.027" class="p2" data-v-352eaaaf></polygon></svg></div> <div></div></div></a></div> <ul class="md-list md-theme-default" data-v-61d4e336><li to="/" class="md-list-item" data-v-61d4e336><a href="/" mdripple="true" class="md-list-item-router md-list-item-container md-button-clean active-link" data-v-61d4e336><div class="md-list-item-content md-ripple"><span class="md-list-item-text" data-v-61d4e336>About me</span> <div></div></div></a></li> <li to="/blog/cn" class="md-list-item blog-list" data-v-61d4e336><a href="/blog/cn" mdripple="true" class="md-list-item-router md-list-item-container md-button-clean" data-v-61d4e336><div class="md-list-item-content md-ripple"><span class="md-list-item-text" data-v-61d4e336>blog/cn</span> <div></div></div></a></li></ul> <!----></div>  <main class="md-app-container md-flex md-layout-column md-theme-default md-scrollbar" style="padding-left:0"><div class="md-toolbar md-app-toolbar md-primary title-bar md-theme-default md-elevation-4" style="top:0" data-v-61d4e336><button type="button" class="md-button md-icon-button menu-button md-theme-default" data-v-61d4e336><div class="md-ripple"><div class="md-button-content"><i class="md-icon md-icon-font md-theme-default" data-v-61d4e336>menu</i></div> <div></div></div></button> <span class="md-title" data-v-61d4e336>Mengdi's Blog</span> <div class="md-toolbar-section-end" data-v-61d4e336><a id="slogon" href="https://www.youtube.com/watch?v=vos32LuLjZs" target="_blank" data-v-61d4e336>♫ Monday 和你走到 Sunday ♪</a></div></div> <div class="md-app-scroller md-layout-column md-flex md-theme-default md-scrollbar"><div class="md-content md-app-content md-flex app-content md-theme-default" data-v-61d4e336><section class="container page-container" data-v-df5e1510 data-v-61d4e336><div data-v-df5e1510><h1 data-v-df5e1510>
      A Workaround for offset re-location in Single-Page Apps
      <ul class="links" data-v-df5e1510></ul></h1> <div class="subhead" data-v-df5e1510><span data-v-df5e1510>07/09/2015 23:53:21</span> <span data-v-df5e1510>@ New York</span></div> <div class="article-content" data-v-df5e1510><p>It's a shared view that a single-page application (SPA) offers users better experience. However, in order to gain the benefits, developers have to take care of a lot of details ourselves. Browser's navigation (back/forward) is one of them.</p>
<p>Web applications often provide linkable, bookmarkable, shareable URLs for important locations in the app. In an SPA, either <a href="https://css-tricks.com/using-the-html5-history-api/">HTML5 History API</a> or hash fragments (<code>#page</code>) is used to provide these permalinks. When a <code>popstate</code> or <code>hashchange</code> event is triggered, a listener function is executed, changing some part of the page instead of loading another page. A typical way (using jQuery) to replace content of the page when a route is matched is like this:</p>
<pre><code class="language-javascript">var $container = $('#container');
...
// when some route is matched
var view = new AnotherPage();
$container.html(view.render().el);
</code></pre>
<h2>The problem</h2>
<p>Here's the problem: if content in <code>el</code> is bigger than window height, user can scroll down to a certain position. The next time <code>el</code> replace content of <code>$container</code>, the browser stays at that position. We should tell the browser to go back to the top, just like when it loads a new page. The code is pretty simple:</p>
<pre><code class="language-javascript">window.scrollTo(0, 0)
</code></pre>
<p>And then browser always scroll to top whenever a route is matched and the content is replaced.</p>
<p>It works perfectly, until the user clicks the back/forward button. In this case, the browser is supposed to scroll back to where it was before. Actually it still does so, but <code>window.scrollTo(0, 0)</code> tells it to go to the top. You will probably notice that the browser goes back to where it was at first and after a galance it scrolls to the top again.</p>
<p>I have tried many different ways to solve this problem. A straight-forward idea is to calculate the correct position instead of 0. I even implenmented a histroy manager toolkit to keep track of all history visits and positions. However, it turns out the best way is the opposite:</p>
<p>Only run <code>scrollTo</code> when it's necessary.</p>
<p>Here's how: <a href="https://github.com/mondaychen/mondaychen.github.io/blob/master/js/app/history-position.js">https://github.com/mondaychen/mondaychen.github.io/blob/master/js/app/history-position.js</a></p>
<h2>Explanation</h2>
<p>I use a variable <code>lastUserJump</code> to store the url/fragment from links. For example, when the user clicks <code>&lt;a href="#page">Page Link&lt;/a></code>, <code>lastUserJump</code> is set to <code>"page"</code>. Then I have:</p>
<pre><code class="language-javascript">$container.html(el)
// jump to top if needed
if (historyManager.isUserJump(Backbone.history.fragment)) {
  window.scrollTo(0, 0)
}
</code></pre>
<p>Only when the new URL equals <code>lastUserJump</code>, tell browser to scroll to top. Since back/forward buttons do not set <code>lastUserJump</code>, it will allow the browser to position correctly.</p>
<h2>Still not good enough!</h2>
<p>Now theoretically it is perfect: it goes to the top when the user clicks on a link, and stays at the right position when the user clicks back/forward buttons (or keyboard control; anything not links). However, <code>el</code> could be very long, and scroll offsets can be big numbers. If the earlier offset is bigger than current window height, the browser can not jump to the correct position. One way to avoid this is the following:</p>
<pre><code class="language-javascript">// make body long enough to help browser jump to the right position
$body.css('min-height', '99999px')
// set dom
$container.html(el)
// jump to top if needed
if (historyManager.isUserJump(Backbone.history.fragment)) {
  window.scrollTo(0, 0)
}
// after 0.1s set min-height to a normal value
// hopefully no one will notice that
_.delay(function () {
  $body.css('min-height', '450px')
}, 100)
</code></pre>
<p>Finally you can have it: a website that runs faster, and still have nice navigation experience.</p>
</div> <div class="no-ssr-placeholder" data-v-df5e1510 data-v-df5e1510>loading...</div></div></section> <footer id="footer" data-v-61d4e336><div class="copyright" data-v-61d4e336>
          Developed & Designed by Mengdi Chen. All rights reserved.<br data-v-61d4e336>
          All articles are licensed by <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank" title="Creative Commons BY 3.0" data-v-61d4e336>CC BY 3.0</a></div> <div class="credit" data-v-61d4e336>
          Icons made by <a href="http://www.flaticon.com/authors/dave-gandy" target="_blank" title="Dave Gandy" data-v-61d4e336>Dave Gandy</a>, <a href="http://www.flaticon.com/authors/freepik" target="_blank" title="Freepik" data-v-61d4e336>Freepik</a> from <a href="http://www.flaticon.com" target="_blank" title="Flaticon" data-v-61d4e336>www.flaticon.com</a>, licensed by <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank" title="Creative Commons BY 3.0" data-v-61d4e336>CC BY 3.0</a></div></footer></div></div></main> </div></div></div></div><script defer src="/_nuxt/static/1716479539/blog/en/A-Workaround-for-offset-relocation-in-Single-Page-Apps/state.js"></script><script src="/_nuxt/f477db7.js" defer></script><script src="/_nuxt/e378fc1.js" defer></script><script src="/_nuxt/a8e9045.js" defer></script><script src="/_nuxt/e1b5a9c.js" defer></script>
  </body>
</html>
